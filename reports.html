<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>IP Reports</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<div class="topbar">
  <h2>EXAMITY | IP Inventory Dashboard</h2>
</div>

<aside class="sidebar">
  <ul>
    <li><a href="index.html">Dashboard</a></li>
    <li><a href="inventory.html">IP Inventory</a></li>
    <li class="active">Reports</li>
    <li><a href="manage.html">Manage IPs</a></li>
  </ul>
</aside>

<main class="content">

<!-- EXPORT -->
<section class="report-section">
  <h3>ðŸ“¦ Export IP Inventory</h3>
  <div class="report-controls">
    <button style="background:#16a34a;color:#fff"
            onclick="exportFullInventory()">Export Full Inventory</button>
  </div>
</section>

<!-- CUSTOM REPORT -->
<section class="report-section">
  <h3>ðŸ›  Custom Report</h3>
  <div class="report-controls">
    <select id="reportType">
      <option value="status">IP Status Summary</option>
      <option value="location">Location-wise Report</option>
      <option value="vlan">VLAN-wise Report</option>
      <option value="used">Used IPs</option>
      <option value="free">Free IPs</option>
    </select>
    <button onclick="runCustomReport()">Run Report</button>
  </div>
</section>

<!-- IMPORT -->
<section class="report-section">
  <h3>ðŸ“¥ Import Inventory (Strict)</h3>
  <div class="report-controls">
    <input type="file" id="csvFile" accept=".csv">
    <button onclick="importCSV()">Import CSV</button>
  </div>
</section>

</main>

<script>
/* ================= DATA ================= */
let ipData = JSON.parse(localStorage.getItem("ipData") || "[]");

/* ================= UTIL ================= */
function downloadFile(content, filename) {
  const blob = new Blob([content], { type: "text/csv" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = filename;
  a.click();
  URL.revokeObjectURL(url);
}

/* ================= EXPORT ================= */
function exportFullInventory() {
  if (ipData.length === 0) {
    alert("No data available");
    return;
  }

  const headers = [
    "IP","Hostname","Location","Zone",
    "VLAN","Device","OS","Status","Owner"
  ];

  let csv = headers.join(",") + "\n";
  ipData.forEach(ip => {
    csv += headers.map(h => `"${ip[h.toLowerCase()] || ""}"`).join(",") + "\n";
  });

  downloadFile(csv, "ip_full_inventory.csv");
}

/* ================= CUSTOM REPORT ================= */
function runCustomReport() {
  const type = document.getElementById("reportType").value;
  let csv = "", filename = "report.csv";

  if (type === "status") {
    csv = "Status,IP\n";
    ipData.forEach(ip => csv += `${ip.status},${ip.ip}\n`);
    filename = "status_report.csv";
  }
  if (type === "location") {
    csv = "Location,IP\n";
    ipData.forEach(ip => csv += `${ip.location},${ip.ip}\n`);
    filename = "location_report.csv";
  }
  if (type === "vlan") {
    csv = "VLAN,IP\n";
    ipData.forEach(ip => csv += `${ip.vlan},${ip.ip}\n`);
    filename = "vlan_report.csv";
  }
  if (type === "used") {
    csv = "IP,Status\n";
    ipData.filter(i =>
  ["used","static"].includes((i.status || "").toLowerCase())
)

      .forEach(i => csv += `${i.ip},Used\n`);
    filename = "used_ips.csv";
  }
  if (type === "free") {
    csv = "IP,Status\n";
    ipData.filter(i => (i.status||"").toLowerCase()==="free")
      .forEach(i => csv += `${i.ip},Free\n`);
    filename = "free_ips.csv";
  }

  downloadFile(csv, filename);
}

/* ================= IMPORT CSV ================= */
function importCSV() {
  const fileInput = document.getElementById("csvFile");
  if (!fileInput.files.length) {
    alert("CSV Import Error\nPlease select a CSV file.");
    return;
  }

  const reader = new FileReader();
  reader.onload = function (e) {

    const lines = e.target.result.split(/\r?\n/);

    const expectedHeader = [
      "IP","Hostname","Location","Zone",
      "VLAN","Device","OS","Status","Owner"
    ];

    const header = lines[0].split(",").map(h => h.replace(/"/g,"").trim());
    for (let i = 0; i < expectedHeader.length; i++) {
      if (header[i] !== expectedHeader[i]) {
        alert(
          "CSV Import Error\nInvalid header format.\n\nExpected:\n" +
          expectedHeader.join(", ")
        );
        return;
      }
    }

    const newRows = [];

    for (let i = 1; i < lines.length; i++) {
      const lineNo = i + 1;
      const cols = lines[i].split(",").map(v => v.replace(/"/g,"").trim());

      if (!cols.some(v => v !== "")) continue;

      const errors = [];

      if (!cols[0]) errors.push("IP is missing");
      if (!cols[2]) errors.push("Location is missing");
      if (!cols[4]) errors.push("VLAN is missing");
      if (!cols[7]) errors.push("Status is missing");

      if (errors.length) {
        alert("CSV Import Error\nLine " + lineNo + ":\n- " + errors.join("\n- "));
        return;
      }

      const duplicateDb = ipData.some(d =>
        d.ip === cols[0] &&
        d.location === cols[2] &&
        d.zone === cols[3] &&
        String(d.vlan) === String(cols[4])
      );

      const duplicateCsv = newRows.some(d =>
        d.ip === cols[0] &&
        d.location === cols[2] &&
        d.zone === cols[3] &&
        String(d.vlan) === String(cols[4])
      );

      if (duplicateDb || duplicateCsv) {
        alert("CSV Import Error\nLine " + lineNo +
              ":\nDuplicate IP in same Location / Zone / VLAN");
        return;
      }

      newRows.push({
        ip: cols[0],
        hostname: cols[1],
        location: cols[2],
        zone: cols[3],
        vlan: cols[4],
        device: cols[5],
        os: cols[6],
        status: cols[7],
        owner: cols[8]
      });
    }

    ipData = ipData.concat(newRows);
    localStorage.setItem("ipData", JSON.stringify(ipData));
    alert(`Import successful.\nRows added: ${newRows.length}`);
  };

  reader.readAsText(fileInput.files[0]);
}
</script>

</body>
</html>
