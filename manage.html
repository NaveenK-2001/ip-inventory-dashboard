<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Manage IPs</title>
<link rel="stylesheet" href="style.css">
<script src="app.js" defer></script>
</head>

<body>

<div class="topbar">
  <h2>EXAMITY | IP Inventory Dashboard</h2>
</div>

<aside class="sidebar">
  <ul>
    <li><a href="index.html">Dashboard</a></li>
    <li><a href="inventory.html">IP Inventory</a></li>
    <li><a href="reports.html">Reports</a></li>
    <li class="active">Manage IPs</li>
  </ul>
</aside>

<main class="content">

<h2 class="page-title">üîç Search & Manage IPs</h2>

<!-- SEARCH PANEL -->
<section class="box">
  <div class="form-grid" style="grid-template-columns:repeat(4,1fr)">
    <select id="sLocation" onchange="onLocationChange()">
      <option value="">Select Location</option>
    </select>

    <select id="sZone" onchange="onZoneChange()" disabled>
      <option value="">Select Zone</option>
    </select>

    <select id="sVlan" disabled>
      <option value="">Select VLAN</option>
    </select>

    <input id="sIp" placeholder="Search IP (optional)">
  </div>

  <button style="margin-top:16px" onclick="searchIPs()">Search</button>
</section>

<!-- RESULTS -->
<section class="box" style="margin-top:20px">
  <h3>Results</h3>
  <div style="overflow-x:auto">
    <table>
      <thead>
        <tr>
          <th>IP</th>
          <th>Hostname</th>
          <th>Location</th>
          <th>Zone</th>
          <th>VLAN</th>
          <th>Status</th>
          <th>Owner</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="resultsTable"></tbody>
    </table>
  </div>
</section>

</main>

<script>
let searchResults = [];



/* ================= INIT DROPDOWNS ================= */
document.addEventListener("DOMContentLoaded", initDropdowns);

function initDropdowns() {
  const data = getIPData();
  const locations = [...new Set(data.map(i => i.location))];

  const locSelect = document.getElementById("sLocation");
  locations.forEach(loc => {
    locSelect.innerHTML += `<option value="${loc}">${loc}</option>`;
  });
}

/* ================= LOCATION CHANGE ================= */
function onLocationChange() {
  const data = getIPData();
  const loc = document.getElementById("sLocation").value;

  const zoneSelect = document.getElementById("sZone");
  const vlanSelect = document.getElementById("sVlan");

  zoneSelect.innerHTML = `<option value="">Select Zone</option>`;
  vlanSelect.innerHTML = `<option value="">Select VLAN</option>`;
  vlanSelect.disabled = true;

  if (!loc) {
    zoneSelect.disabled = true;
    return;
  }

  const zones = [...new Set(
    data.filter(i => i.location === loc).map(i => i.zone)
  )];

  zones.forEach(z => {
    zoneSelect.innerHTML += `<option value="${z}">${z}</option>`;
  });

  zoneSelect.disabled = false;
}

/* ================= ZONE CHANGE ================= */
function onZoneChange() {
  const data = getIPData();
  const loc = document.getElementById("sLocation").value;
  const zone = document.getElementById("sZone").value;

  const vlanSelect = document.getElementById("sVlan");
  vlanSelect.innerHTML = `<option value="">Select VLAN</option>`;

  if (!zone) {
    vlanSelect.disabled = true;
    return;
  }

  const vlans = [...new Set(
    data
      .filter(i => i.location === loc && i.zone === zone)
      .map(i => String(i.vlan))
  )];

  vlans.sort((a, b) => a - b);

  vlans.forEach(v => {
    vlanSelect.innerHTML += `<option value="${v}">VLAN ${v}</option>`;
  });

  vlanSelect.disabled = false;
}

/* ================= SEARCH ================= */
function searchIPs() {
  const loc = document.getElementById("sLocation").value;
  const zone = document.getElementById("sZone").value;
  const vlan = document.getElementById("sVlan").value;
  const ipVal = document.getElementById("sIp").value.trim();

  const data = getIPData();

  searchResults = data
    .map((ip, index) => ({ ip, index }))
    .filter(item =>
      (!loc || item.ip.location === loc) &&
      (!zone || item.ip.zone === zone) &&
      (!vlan || String(item.ip.vlan) === vlan) &&
      (!ipVal || item.ip.ip.includes(ipVal))
    );

  renderResults();
}

/* ================= RENDER ================= */
function renderResults() {
  const table = document.getElementById("resultsTable");
  table.innerHTML = "";

  if (searchResults.length === 0) {
    table.innerHTML = `<tr><td colspan="8">No matching IPs found</td></tr>`;
    return;
  }

  searchResults.forEach((item, rowIdx) => {
    const ip = item.ip;

    table.innerHTML += `
      <tr>
        <td><input value="${ip.ip}" disabled></td>
        <td><input value="${ip.hostname || ""}"></td>
        <td><input value="${ip.location}" disabled></td>
        <td><input value="${ip.zone}" disabled></td>
        <td><input value="${ip.vlan}" disabled></td>
        <td>
          <select>
  <option ${normalizeStatus(ip.status)==="Used"?"selected":""}>Used</option>
  <option ${normalizeStatus(ip.status)==="Free"?"selected":""}>Free</option>
  <option ${normalizeStatus(ip.status)==="Reserved"?"selected":""}>Reserved</option>
  <option ${normalizeStatus(ip.status)==="Static"?"selected":""}>Static</option>
</select>

        </td>
        <td><input value="${ip.owner || ""}"></td>
        <td>
          <button onclick="saveIP(${rowIdx})">Save</button>
          <button onclick="deleteIP(${rowIdx})">Delete</button>
        </td>
      </tr>
    `;
  });
}

/* ================= SAVE ================= */
function saveIP(rowIdx) {
  const row = document.getElementById("resultsTable").rows[rowIdx];
  const original = searchResults[rowIdx].ip;

  const updatedIP = {
    ...original,
    hostname: row.cells[1].querySelector("input").value,
    status: row.cells[5].querySelector("select").value,
    owner: row.cells[6].querySelector("input").value
  };

  ipData = ipData.map(ip =>
    ip.ip === original.ip &&
    ip.location === original.location &&
    ip.zone === original.zone &&
    String(ip.vlan) === String(original.vlan)
      ? updatedIP
      : ip
  );

  localStorage.setItem("ipData", JSON.stringify(ipData));
  alert("IP updated successfully");
  searchIPs();
}


/* ================= DELETE ================= */
function deleteIP(rowIdx) {
  if (!confirm("Are you sure you want to delete this IP?")) return;

  const target = searchResults[rowIdx].ip;

  ipData = ipData.filter(ip =>
    !(
      ip.ip === target.ip &&
      ip.location === target.location &&
      ip.zone === target.zone &&
      String(ip.vlan) === String(target.vlan)
    )
  );

  localStorage.setItem("ipData", JSON.stringify(ipData));
  searchIPs();
}

</script>

</body>
</html>
